<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Run Python embedded in OPM Flow &mdash; OPM Python Documentation 2025.10-pre documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/_rst_properties.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=3ed3d3d8"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="OPM Common Python Documentation" href="common.html" />
    <link rel="prev" title="Run OPM Flow from Python" href="flow-in-python.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            OPM Python Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="flow-in-python.html">Run OPM Flow from Python</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Run Python embedded in OPM Flow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#stateful-behavior-using-python-classes">Stateful behavior using Python classes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="common.html">OPM Common Python Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="simulators.html">OPM Simulators Python Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">OPM Python Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Run Python embedded in OPM Flow</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/OPM/opm-python-documentation/blob/master/python/docs/embedded-python.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="run-python-embedded-in-opm-flow">
<h1>Run Python embedded in OPM Flow<a class="headerlink" href="#run-python-embedded-in-opm-flow" title="Link to this heading"></a></h1>
<p>The PYACTION keyword is a Flow specific keyword which allows for executing embedded Python
code in the SCHEDULE section. The embedded Python code will then be executed at the end of each successful timestep.</p>
<p>The PYACTION keyword is inspired
by the ACTIONX keyword, but instead of a .DATA formatted condition you
are allowed to implement the condition with a general Python script. The
ACTIONX keywords are very clearly separated in a condition part and an
action part in the form of a list of keywords which are effectively injected in
the SCHEDULE section when the condition evaluates to true.
This is not so for PYACTION where there is one Python script in which both
conditions can be evaluated and changes applied.</p>
<p>See also: PYACTION in the <a class="reference external" href="https://opm-project.org/?page_id=955">reference manual</a> for more information and <a class="reference external" href="https://github.com/OPM/opm-tests/tree/master/pyaction">opm-tests</a> for examples.</p>
<p>In order to enable the PYACTION keyword:</p>
<ol class="arabic simple">
<li><p>Compile Flow with Embedded Python support:</p>
<ul class="simple">
<li><p>Add the cmake flags <code class="docutils literal notranslate"><span class="pre">-DOPM_ENABLE_PYTHON=ON</span></code> and <code class="docutils literal notranslate"><span class="pre">-DOPM_ENABLE_EMBEDDED_PYTHON=ON</span></code> (you can also change these settings in the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> of <code class="docutils literal notranslate"><span class="pre">opm-common</span></code> and <code class="docutils literal notranslate"><span class="pre">opm-simulators</span></code>).</p></li>
</ul>
</li>
</ol>
<ol class="arabic" start="2">
<li><p>The keyword PYACTION must be added to the SCHEDULE section:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">PYACTION_NAME</span><span class="o">&gt;</span>  <span class="o">&lt;</span><span class="n">SINGLE</span><span class="o">/</span><span class="n">UNLIMITED</span><span class="o">&gt;</span> <span class="o">/</span>
<span class="o">&lt;</span><span class="n">pythonscript</span><span class="o">&gt;</span> <span class="o">/</span> <span class="o">--</span> <span class="n">path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">python</span> <span class="n">script</span><span class="p">,</span> <span class="n">relative</span> <span class="n">to</span> <span class="n">the</span> <span class="n">location</span> <span class="n">of</span> <span class="n">the</span> <span class="n">DATA</span><span class="o">-</span><span class="n">file</span>
</pre></div>
</div>
</li>
<li><p>You need to provide the Python script.</p>
<p>To interact with the simulator in the embedded Python code, you can access four variables from the simulator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python module opm_embedded</span>
<span class="kn">import</span> <span class="nn">opm_embedded</span>
<span class="c1"># The current EclipseState</span>
<span class="n">ecl_state</span> <span class="o">=</span> <span class="n">opm_embedded</span><span class="o">.</span><span class="n">current_ecl_state</span>
<span class="c1"># The current Schedule</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="n">opm_embedded</span><span class="o">.</span><span class="n">current_schedule</span>
<span class="c1"># The current SummaryState</span>
<span class="n">summary_state</span> <span class="o">=</span> <span class="n">opm_embedded</span><span class="o">.</span><span class="n">current_summary_state</span>
<span class="c1"># The current report step</span>
<span class="n">report_step</span> <span class="o">=</span> <span class="n">opm_embedded</span><span class="o">.</span><span class="n">current_report_step</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">current_ecl_state</span></code>: An instance of the <a class="reference external" href="common.html#opm.io.ecl_state.EclipseState">EclipseState</a> class — this is a representation of all static properties in the model, ranging from porosity to relperm tables. The content of the ecl state is immutable — you are not allowed to change the static properties at runtime.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">current_schedule</span></code>: An instance of the <a class="reference external" href="common.html#opm.io.schedule.Schedule">Schedule</a> class — this is a representation of all the content from the SCHEDULE section, notably all well and group information and the timestepping.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">current_report_step</span></code>: This is an integer for the report step we are currently working on. Observe that the PYACTION is called for every simulator timestep, i.e. it will typically be called multiple times with the same value for the report step argument.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">current_summary_state</span></code>: An instance of the <a class="reference external" href="common.html#opm.io.sim.SummaryState">SummaryState</a> class — this is where the current summary results of the simulator are stored. The <a class="reference external" href="common.html#opm.io.sim.SummaryState">SummaryState</a> class has methods to get hold of well, group, and general variables.</p></li>
</ul>
</li>
</ol>
<section id="stateful-behavior-using-python-classes">
<h2>Stateful behavior using Python classes<a class="headerlink" href="#stateful-behavior-using-python-classes" title="Link to this heading"></a></h2>
<p>In the below code snippet, we use a <code class="docutils literal notranslate"><span class="pre">WellController</span></code> class to manage production wells by tracking their status and simulation timing.
We create one instance of the WellController and use its internal state across multiple timesteps and PYACTION calls.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">opm_embedded</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="c1"># Check if the setup has already been done to avoid reinitialization</span>
<span class="k">if</span> <span class="s1">&#39;setup_done&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="c1"># Target oil production rate in standard units (e.g., stb/day)</span>
    <span class="n">OIL_RATE_TARGET</span> <span class="o">=</span> <span class="mi">8000</span>
    <span class="c1"># Minimum time in days between opening new wells</span>
    <span class="n">MIN_DAYS_BETWEEN_OPENINGS</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="k">class</span> <span class="nc">WellController</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A controller to manage the opening of production wells based on</span>
<span class="sd">        oil rate targets and elapsed simulation time.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            closed_wells (list[str]): List of wells yet to be opened.</span>
<span class="sd">            last_opening_time (datetime): Simulation time of the last well opening.</span>
<span class="sd">                                          Initially, this is set to the simulation start time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">well_names</span><span class="p">,</span> <span class="n">start_time</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Initialize the WellController.</span>

<span class="sd">            Args:</span>
<span class="sd">                well_names (list[str]): Names of wells to be controlled.</span>
<span class="sd">                start_time (datetime): Simulation start time.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed_wells</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">well_names</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_opening_time</span> <span class="o">=</span> <span class="n">start_time</span>

        <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_oil_rate</span><span class="p">,</span> <span class="n">current_time</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Evaluate the current oil production and determine whether to open</span>
<span class="sd">            a new well based on the target rate and time since the last opening.</span>

<span class="sd">            Args:</span>
<span class="sd">                current_oil_rate (float): The current oil rate.</span>
<span class="sd">                current_time (datetime): Current simulation time.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">days_since_last_opening</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_opening_time</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">current_oil_rate</span> <span class="o">&lt;</span> <span class="n">OIL_RATE_TARGET</span> <span class="ow">and</span>
                <span class="n">days_since_last_opening</span> <span class="o">&gt;=</span> <span class="n">MIN_DAYS_BETWEEN_OPENINGS</span> <span class="ow">and</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">closed_wells</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>

                <span class="n">next_well</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed_wells</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_opening_time</span> <span class="o">=</span> <span class="n">current_time</span>

                <span class="n">schedule</span><span class="o">.</span><span class="n">open_well</span><span class="p">(</span><span class="n">next_well</span><span class="p">)</span>
                <span class="n">opm_embedded</span><span class="o">.</span><span class="n">OpmLog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Opened well </span><span class="si">{</span><span class="n">next_well</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">set_next_dt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_time</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Insert the NEXTSTEP keyword to control the simulator&#39;s timestep,</span>
<span class="sd">            adjusting based on whether a well was just opened.</span>

<span class="sd">            Args:</span>
<span class="sd">                current_time (datetime): Current simulation time.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed_wells</span><span class="p">:</span>
                <span class="n">days_since_last_opening</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_opening_time</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
                <span class="k">if</span> <span class="n">days_since_last_opening</span> <span class="o">&gt;=</span> <span class="n">MIN_DAYS_BETWEEN_OPENINGS</span><span class="p">:</span>
                    <span class="n">next_dt</span> <span class="o">=</span> <span class="mf">10.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">next_dt</span> <span class="o">=</span> <span class="mf">50.0</span>
                <span class="n">kw</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                NEXTSTEP</span>
<span class="s2">                </span><span class="si">{</span><span class="n">next_dt</span><span class="si">}</span><span class="s2"> /</span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="n">schedule</span><span class="o">.</span><span class="n">insert_keywords</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>

    <span class="c1"># Instantiate the controller with a list of wells and simulation start time</span>
    <span class="c1"># This controller will be instatiated once and be used in all following PYACTION calls.</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">WellController</span><span class="p">(</span><span class="n">well_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PROD01&#39;</span><span class="p">,</span> <span class="s1">&#39;PROD02&#39;</span><span class="p">],</span>
                  <span class="n">start_time</span><span class="o">=</span><span class="n">opm_embedded</span><span class="o">.</span><span class="n">current_schedule</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="n">setup_done</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Retrieve current simulation components from the OPM embedded module</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="n">opm_embedded</span><span class="o">.</span><span class="n">current_schedule</span>
<span class="n">report_step</span> <span class="o">=</span> <span class="n">opm_embedded</span><span class="o">.</span><span class="n">current_report_step</span>
<span class="n">summary_state</span> <span class="o">=</span> <span class="n">opm_embedded</span><span class="o">.</span><span class="n">current_summary_state</span>

<span class="c1"># Compute the current simulation time</span>
<span class="n">current_time</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">summary_state</span><span class="o">.</span><span class="n">elapsed</span><span class="p">())</span>
<span class="n">current_oil_rate</span> <span class="o">=</span> <span class="n">summary_state</span><span class="o">.</span><span class="n">group_var</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;GOPR&#39;</span><span class="p">)</span>

<span class="c1"># Update well control logic based on current state</span>
<span class="n">controller</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">current_oil_rate</span><span class="p">,</span> <span class="n">current_time</span><span class="p">)</span>
<span class="c1"># Set the next simulation step duration</span>
<span class="n">controller</span><span class="o">.</span><span class="n">set_next_dt</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>

<span class="c1"># Optional logs to track the status of the two wells:</span>
<span class="c1"># opm_embedded.OpmLog.info(&quot;PROD01: {}&quot;.format(schedule.get_well(&quot;PROD01&quot;, report_step).status()))</span>
<span class="c1"># opm_embedded.OpmLog.info(&quot;PROD02: {}&quot;.format(schedule.get_well(&quot;PROD02&quot;, report_step).status()))</span>
</pre></div>
</div>
<p>Use this code snippet with the example <a class="reference external" href="https://github.com/OPM/opm-tests/blob/master/msw/MSW-3D-TWO-PRODUCERS.DATA">MSW-3D-TWO-PRODUCERS</a> by saving the file as <code class="docutils literal notranslate"><span class="pre">wellcontroller.py</span></code> at the same location as <code class="docutils literal notranslate"><span class="pre">MSW-3D-TWO-PRODUCERS.DATA</span></code> and adding</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>PYACTION
WELLCONTROLLER UNLIMITED /
&#39;wellcontroller.py&#39; /
</pre></div>
</div>
<p>to the <code class="docutils literal notranslate"><span class="pre">SCHEDULE</span></code> section of <code class="docutils literal notranslate"><span class="pre">MSW-3D-TWO-PRODUCERS.DATA</span></code>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="flow-in-python.html" class="btn btn-neutral float-left" title="Run OPM Flow from Python" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="common.html" class="btn btn-neutral float-right" title="OPM Common Python Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024 Equinor ASA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other versions</span>
    v: master
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <div class="injected">
      <dl>
        <dt>Branches</dt>
        <dd class="rtd-current-item">
          <a href="../master/index.html">master</a>
        </dd>
        <dd class="">
          <a href="../release-2025.04/index.html">release-2025.04</a>
        </dd>
      </dl>
      <dl>
        <dt>Search</dt>
        <dd>
          <div style="padding: 6px;">
            <form id="flyout-search-form" class="wy-form" target="_blank"
              action="../master/index.html/../search.html"
              method="get">
              <input type="text" name="q" aria-label="Search docs" placeholder="Search docs">
            </form>
          </div>
        </dd>
      </dl>
    </div>
  </div>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>